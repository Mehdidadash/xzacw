#!/bin/bash
# M118: Execute eslah action with parameters (simple and reliable reset)

# Check if we have enough parameters
if [ $# -lt 2 ]; then
    echo "Error: M118 requires P and Q parameters" >&2
    exit 1
fi

# Convert parameters to integers
P_VAL=$(printf "%.0f" "$1")  # workpiece_type as integer
Q_VAL=$(printf "%.0f" "$2")  # slah_count as integere

#echo "M118: P=$P_VAL, Q=$Q_VAL"

# Run Python script with parameters
/home/cnc/anaconda3/bin/python /home/cnc/linuxcnc/configs/xzacw/eslah_m118.py "$P_VAL" "$Q_VAL"

# Check if Python script was successful
if [ $? -eq 0 ]; then
    echo "eslah action completed successfully"
    
    # Simple and reliable reset using the signal
    #echo "Resetting eslah button via signal..."
    halcmd sets eslah-reset 0
    sleep 0.1
    halcmd sets eslah-reset 0  # Double tap for reliability
    
    #echo "eslah button reset completed"
    exit 0
else
    echo "eslah action failed"
    exit 1
fi