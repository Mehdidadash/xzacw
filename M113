#!/bin/bash
# M113 handler to update partcount in variables_handler and variables.txt

# Check if a parameter is provided
if [ -z "$1" ]; then
  echo "Error: No parameter provided."
  exit 1
fi

# Extract the parameter value
new_count=$1

# Unlink the pin from its signal
halcmd unlinkp pyvcp.partcount_display

# Set the HAL pin value
halcmd setp pyvcp.partcount_display "$new_count"

# Reconnect the pin to its signal
halcmd net partcount-sync pyvcp.partcount_display

# Update variables.txt
sed -i "s/^partcount=.*/partcount=$new_count/" /home/cnc/linuxcnc/configs/xzacw/variables.txt

exit 0