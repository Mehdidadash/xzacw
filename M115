#!/bin/bash
# M11 - Read partcount from variables.txt and update pyvcp.partcount_display

# Set path to variables.txt
VARS_FILE="/home/cnc/linuxcnc/configs/xzacw/variables.txt"

# Extract partcount value using grep and cut
partcount=$(grep "^partcount=" "$VARS_FILE" | cut -d '=' -f 2)

# Validate extraction
if [ -z "$partcount" ]; then
  echo "Error: Failed to read partcount from variables.txt"
  exit 1
fi

# Unlink HAL pin from signal
halcmd unlinkp pyvcp.partcount_display

# Set the HAL pin value
halcmd setp pyvcp.partcount_display "$partcount"

# Reconnect the pin to its signal (if necessary)
halcmd net partcount-sync pyvcp.partcount_display

exit 0
