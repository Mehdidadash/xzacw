#!/bin/bash
# M115: update total_machined from variables.txt

VARS_FILE="/home/cnc/linuxcnc/configs/xzacw/variables.txt"
total=$(grep "^total_machined=" "$VARS_FILE" | cut -d '=' -f 2)

if [ -z "$total" ]; then
  echo "Error: Failed to read total_machined from variables.txt"
  exit 1
fi

total=${total%.*}  # Remove decimal part to ensure integer

# Unlink HAL pin from signal
halcmd unlinkp gladevcp.total_machined

# Set the HAL pin value
halcmd setp gladevcp.total_machined "$total"

# Reconnect the pin to its signal
halcmd net total-machined-sync gladevcp.total_machined

echo "M115: Initialized total_machined to $total from variables.txt"
exit 0